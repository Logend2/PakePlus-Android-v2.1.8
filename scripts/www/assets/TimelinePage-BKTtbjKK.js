import{x as ae,m as Q,l as x,p as P,k as Z,d as z,o as b,c as w,a as e,f as y,g as l,C as G,w as V,t as F,s as J,q as oe,j as le,e as K,F as re,r as ie,b as ce,_ as ue,y as de}from"./index-6SxiNpGX.js";import{r as fe,G as W}from"./colorUtils-DrtxhOgE.js";const j=ae("timeline",()=>{const S=Q(),n=x(null),i=x(null),o=x([]),u=x(0),r=x("stopped"),t=x(0),f=x(0),a=x(null),v=x(null),d=x(-1);let g=null,T=0;const s=P(()=>{if(o.value.length===0)return null;const _=t.value+f.value;let p=o.value[0];for(const c of o.value)if(c.timestamp<=_)p=c;else break;return p}),m=P(()=>u.value===0?0:t.value/u.value),h=P(()=>o.value.length>0&&n.value!==null),k=P(()=>r.value==="playing");function C(_){if(o.value.length===0)return-1;let p=-1;for(let c=0;c<o.value.length&&o.value[c].timestamp<=_;c++)p=c;return p}async function $(_){v.value&&URL.revokeObjectURL(v.value),n.value=_,v.value=URL.createObjectURL(_);const c=_.type.startsWith("video/")?document.createElement("video"):new Audio;c.src=v.value,await new Promise((I,O)=>{c.onloadedmetadata=()=>{u.value=c.duration*1e3,I()},c.onerror=()=>O(new Error("Failed to load media"))}),a.value=c}async function M(_){i.value=_;const p=await _.text(),c=R(p);if(o.value=c,c.length>0){const I=c[c.length-1];I.timestamp>u.value&&(u.value=I.timestamp)}}function R(_){const p=_.trim().split(`
`);if(p.length<2)return[];const c=p[0].split(",").map(O=>O.trim()),I=[];for(let O=1;O<p.length;O++){const N=p[O].trim();if(!N)continue;const te=N.split(","),B={};c.forEach((A,se)=>{var Y;B[A]=((Y=te[se])==null?void 0:Y.trim())??""});const ne=parseFloat(B.frame_time_ms??"0"),X=[];for(let A=0;A<10;A++)X.push({mode:parseInt(B[`ch${A}_function`]??"0"),r:parseInt(B[`ch${A}_red`]??"0"),g:parseInt(B[`ch${A}_green`]??"0"),b:parseInt(B[`ch${A}_blue`]??"0")});I.push({timestamp:ne,channels:X})}return I.sort((O,N)=>O.timestamp-N.timestamp)}function E(){!h.value||!a.value||(r.value="playing",a.value||(T=performance.now()-t.value),a.value.currentTime=t.value/1e3,a.value.play().catch(console.error),q())}function D(){r.value="paused",a.value&&a.value.pause(),g!==null&&(cancelAnimationFrame(g),g=null)}function L(){r.value="stopped",t.value=0,d.value=-1,a.value&&(a.value.pause(),a.value.currentTime=0),g!==null&&(cancelAnimationFrame(g),g=null)}function U(_){if(t.value=Math.max(0,Math.min(u.value,_)),d.value=-1,a.value&&(a.value.currentTime=t.value/1e3),r.value==="playing")a.value||(T=performance.now()-t.value);else{const p=t.value+f.value,c=C(p);if(c!==-1&&S.isConnected){const I=o.value[c];Z.sendStream(I.channels).catch(console.error),d.value=c}}}function H(_){f.value=_}function q(){if(r.value!=="playing")return;a.value?t.value=a.value.currentTime*1e3:t.value=performance.now()-T;const _=t.value+f.value,p=C(_);if(p!==-1&&p!==d.value&&S.isConnected){const c=o.value[p];Z.sendStream(c.channels).catch(console.error),d.value=p}if(t.value>=u.value||a.value&&t.value>=a.value.duration*1e3){L();return}g=requestAnimationFrame(q)}function ee(){L(),o.value=[],u.value=0,t.value=0,f.value=0,d.value=-1,v.value&&(URL.revokeObjectURL(v.value),v.value=null),n.value=null,i.value=null,a.value=null}return{mediaFile:n,csvFile:i,frames:o,duration:u,playbackState:r,currentTime:t,offset:f,lastSentFrameIndex:d,currentFrame:s,progress:m,isReady:h,isPlaying:k,mediaElement:a,mediaUrl:v,loadMediaFile:$,loadCSVFile:M,play:E,pause:D,stop:L,seek:U,setOffset:H,reset:ee}}),ve={class:"file-loader"},me={class:"flex gap-4"},pe={class:"flex-1"},ge={class:"flex flex-col items-center gap-1"},he={class:"truncate w-full text-center px-2"},_e={class:"flex-1"},xe={class:"flex flex-col items-center gap-1"},ye=z({__name:"FileLoader",setup(S){const n=j(),i=x(null),o=x(null);async function u(a){var g;const d=(g=a.target.files)==null?void 0:g[0];if(d)try{await n.loadMediaFile(d)}catch(T){console.error("Failed to load media:",T)}}async function r(a){var g;const d=(g=a.target.files)==null?void 0:g[0];if(d)try{await n.loadCSVFile(d)}catch(T){console.error("Failed to load CSV:",T)}}function t(){var a;(a=i.value)==null||a.click()}function f(){var a;(a=o.value)==null||a.click()}return(a,v)=>(b(),w("div",ve,[v[2]||(v[2]=e("div",{class:"text-xs font-mono text-gray-400 uppercase tracking-wider mb-2"}," LOAD FILES ",-1)),e("div",me,[e("div",pe,[e("input",{ref_key:"mediaInput",ref:i,type:"file",accept:"audio/*,video/*",class:"hidden",onChange:u},null,544),y(l(G),{class:"w-full",onClick:t},{default:V(()=>{var d;return[e("div",ge,[v[0]||(v[0]=e("svg",{class:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"})],-1)),e("span",he,F(((d=l(n).mediaFile)==null?void 0:d.name)??"LOAD MEDIA"),1)])]}),_:1})]),e("div",_e,[e("input",{ref_key:"csvInput",ref:o,type:"file",accept:".csv",class:"hidden",onChange:r},null,544),y(l(G),{class:"w-full",onClick:f},{default:V(()=>{var d;return[e("div",xe,[v[1]||(v[1]=e("svg",{class:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"})],-1)),e("span",null,F(((d=l(n).csvFile)==null?void 0:d.name)??"LOAD CSV"),1)])]}),_:1})])])]))}}),be={class:"waveform-display flex flex-col gap-2 relative"},we={key:0,class:"video-preview absolute inset-0 opacity-25 pointer-events-none rounded overflow-hidden flex items-center justify-center bg-black"},ke=["src","currentTime"],Ce={key:0,class:"absolute inset-0 flex items-center justify-center pointer-events-none"},$e={class:"absolute bottom-1 left-2 text-xs font-mono text-gray-400 pointer-events-none shadow-sm drop-shadow-md"},Fe={class:"absolute bottom-1 right-2 text-xs font-mono text-gray-400 pointer-events-none shadow-sm drop-shadow-md"},Se=z({__name:"WaveformDisplay",setup(S){const n=j(),i=x(null),o=x(null),u=P(()=>n.progress),r=P(()=>n.mediaUrl),t=x([]),f=x(!1);let a=null;function v(s){const m=Math.floor(s/1e3),h=Math.floor(m/60),k=m%60;return`${h}:${k.toString().padStart(2,"0")}`}async function d(s){f.value=!0,t.value=[];try{const m=window.AudioContext||window.webkitAudioContext,h=new m,k=await s.arrayBuffer(),$=(await h.decodeAudioData(k)).getChannelData(0),M=Math.ceil($.length/300),R=[];for(let E=0;E<300;E++){let D=0;for(let L=0;L<M;L++){const U=E*M+L;if(U<$.length){const H=Math.abs($[U]);H>D&&(D=H)}}R.push(D)}t.value=R,h.close()}catch(m){console.error("Failed to generate waveform:",m)}finally{f.value=!1,g()}}function g(){if(!i.value||!o.value)return;i.value.width=o.value.clientWidth,i.value.height=o.value.clientHeight;const s=i.value.getContext("2d");if(!s)return;const m=i.value.width,h=i.value.height;if(s.clearRect(0,0,m,h),t.value.length>0){const C=m/t.value.length;s.fillStyle="#1D4ED8";for(let M=0;M<t.value.length;M++){const R=t.value[M]*h*.9,E=M*C,D=(h-R)/2;s.fillRect(E,D,Math.max(1,C-1),R)}const $=m*u.value;s.fillStyle="#00E5FF",s.globalCompositeOperation="source-atop",s.fillRect(0,0,$,h),s.globalCompositeOperation="source-over"}else if(!f.value&&!n.mediaFile){s.strokeStyle="#333",s.lineWidth=1;for(let C=0;C<=4;C++){const $=h/4*C;s.beginPath(),s.moveTo(0,$),s.lineTo(m,$),s.stroke()}}const k=m*u.value;s.strokeStyle="#00E5FF",s.lineWidth=2,s.beginPath(),s.moveTo(k,0),s.lineTo(k,h),s.stroke(),s.fillStyle="#00E5FF",s.beginPath(),s.moveTo(k-5,0),s.lineTo(k+5,0),s.lineTo(k,10),s.closePath(),s.fill()}function T(s){if(!i.value||n.duration===0)return;const m=i.value.getBoundingClientRect(),k=(s.clientX-m.left)/m.width;n.seek(k*n.duration)}return J(()=>n.mediaFile,s=>{s?d(s):(t.value=[],g())}),J([u],()=>{g()}),oe(()=>{o.value&&(a=new ResizeObserver(()=>{g()}),a.observe(o.value)),n.mediaFile&&t.value.length===0?d(n.mediaFile):g()}),le(()=>{a&&a.disconnect()}),(s,m)=>{var h;return b(),w("div",be,[r.value&&((h=l(n).mediaFile)!=null&&h.type.startsWith("video/"))?(b(),w("div",we,[e("video",{src:r.value,currentTime:l(n).currentTime/1e3,class:"object-cover w-full h-full",muted:""},null,8,ke)])):K("",!0),e("div",{ref_key:"waveformContainerDiv",ref:o,class:"relative w-full h-32 rounded border border-gray-700 bg-[#121212]/80"},[f.value?(b(),w("div",Ce,[...m[0]||(m[0]=[e("span",{class:"text-cyan text-sm font-mono animate-pulse"},"GENERATING WAVEFORM...",-1)])])):K("",!0),e("canvas",{ref_key:"canvas",ref:i,class:"w-full h-full cursor-pointer absolute inset-0",onClick:T},null,512),e("div",$e,F(v(l(n).currentTime)),1),e("div",Fe,F(v(l(n).duration)),1)],512)])}}}),Te={class:"frame-monitor"},Me={key:0,class:"space-y-2"},Ie={class:"flex justify-between text-sm font-mono"},Oe={class:"text-cyan"},Ve={class:"grid grid-cols-5 gap-1"},Ae={class:"text-xs font-mono text-gray-500 mt-1"},Pe={class:"flex justify-between text-xs font-mono text-gray-400"},Re={key:1,class:"text-gray-500 text-sm font-mono text-center py-8"},Ee=z({__name:"FrameMonitor",setup(S){const n=j(),i=P(()=>n.currentFrame),o=u=>(u/1e3).toFixed(3)+"s";return(u,r)=>(b(),w("div",Te,[r[2]||(r[2]=e("div",{class:"text-xs font-mono text-gray-400 uppercase tracking-wider mb-2"}," CURRENT FRAME ",-1)),i.value?(b(),w("div",Me,[e("div",Ie,[r[0]||(r[0]=e("span",{class:"text-gray-400"},"Time:",-1)),e("span",Oe,F(o(i.value.timestamp)),1)]),e("div",Ve,[(b(!0),w(re,null,ie(i.value.channels,(t,f)=>(b(),w("div",{key:f,class:"channel-preview p-1 rounded border border-gray-700 bg-black text-center"},[e("div",{class:"w-full aspect-square rounded",style:ce({backgroundColor:l(fe)(t.r,t.g,t.b)})},null,4),e("div",Ae," Z"+F(f),1)]))),128))]),e("div",Pe,[r[1]||(r[1]=e("span",null,"Offset:",-1)),e("span",null,F(l(n).offset)+"ms",1)])])):(b(),w("div",Re," No frame data "))]))}}),De=ue(Ee,[["__scopeId","data-v-f62d42e9"]]),Le={class:"playback-controls"},ze={class:"flex items-center gap-4"},Be={class:"flex items-center gap-2"},We={key:0,class:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor"},je={key:1,class:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor"},Ue={class:"flex items-center gap-2"},He={class:"text-xs font-mono text-gray-400 uppercase"},Ne=z({__name:"PlaybackControls",setup(S){const n=j(),i=Q();function o(){n.isPlaying?n.pause():n.play()}function u(){n.stop()}return(r,t)=>(b(),w("div",Le,[e("div",ze,[y(l(G),{size:"lg",variant:l(n).isPlaying?"purple":"cyan",disabled:!l(n).isReady||!l(i).isConnected,glowing:l(n).isPlaying,onClick:o},{default:V(()=>[e("div",Be,[l(n).isPlaying?(b(),w("svg",je,[...t[1]||(t[1]=[e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"},null,-1)])])):(b(),w("svg",We,[...t[0]||(t[0]=[e("path",{d:"M8 5v14l11-7z"},null,-1)])])),e("span",null,F(l(n).isPlaying?"PAUSE":"PLAY"),1)])]),_:1},8,["variant","disabled","glowing"]),y(l(G),{size:"lg",variant:"red",disabled:!l(n).isReady,onClick:u},{default:V(()=>[...t[2]||(t[2]=[e("div",{class:"flex items-center gap-2"},[e("svg",{class:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})]),e("span",null,"STOP")],-1)])]),_:1},8,["disabled"]),e("div",Ue,[y(l(de),{active:l(n).isPlaying&&l(i).isConnected,color:"cyan"},null,8,["active"]),e("span",He,F(l(n).playbackState),1)])])]))}}),Ge={class:"offset-calibrator"},qe={class:"flex items-center gap-4"},Xe={class:"flex-1 text-center"},Ye={class:"text-lg font-mono text-cyan"},Ze=z({__name:"OffsetCalibrator",setup(S){const n=j(),i=P(()=>{const r=n.offset;return r>=0?`+${r}ms`:`${r}ms`});function o(r){n.setOffset(n.offset+r)}function u(){n.setOffset(0)}return(r,t)=>(b(),w("div",Ge,[t[4]||(t[4]=e("div",{class:"text-xs font-mono text-gray-400 uppercase tracking-wider mb-2"}," TIMING OFFSET ",-1)),e("div",qe,[e("button",{class:"w-10 h-10 rounded border border-gray-700 bg-black text-gray-400 hover:border-cyan hover:text-cyan transition-colors",onClick:t[0]||(t[0]=f=>o(-50))}," -50 "),e("button",{class:"w-8 h-8 rounded border border-gray-700 bg-black text-gray-400 hover:border-cyan hover:text-cyan transition-colors",onClick:t[1]||(t[1]=f=>o(-10))}," -10 "),e("div",Xe,[e("div",Ye,F(i.value),1),e("button",{class:"text-xs text-gray-500 hover:text-gray-300",onClick:u}," reset ")]),e("button",{class:"w-8 h-8 rounded border border-gray-700 bg-black text-gray-400 hover:border-cyan hover:text-cyan transition-colors",onClick:t[2]||(t[2]=f=>o(10))}," +10 "),e("button",{class:"w-10 h-10 rounded border border-gray-700 bg-black text-gray-400 hover:border-cyan hover:text-cyan transition-colors",onClick:t[3]||(t[3]=f=>o(50))}," +50 ")]),t[5]||(t[5]=e("div",{class:"text-xs text-gray-500 mt-2 text-center"}," Adjust sync between audio and lights ",-1))]))}}),Je={class:"timeline-view flex flex-col gap-4 h-full p-4"},Ke={class:"flex flex-col md:flex-row gap-4 md:flex-1"},Qe={class:"flex-1 flex flex-col gap-4"},et=z({__name:"TimelineView",setup(S){return(n,i)=>(b(),w("div",Je,[y(l(W),null,{default:V(()=>[y(ye)]),_:1}),y(l(W),{title:"WAVEFORM"},{default:V(()=>[y(Se)]),_:1}),e("div",Ke,[e("div",Qe,[y(l(W),null,{default:V(()=>[y(Ne)]),_:1}),y(l(W),null,{default:V(()=>[y(Ze)]),_:1})]),y(l(W),{class:"w-full md:w-80"},{default:V(()=>[y(De)]),_:1})])]))}}),tt={class:"timeline-page h-full overflow-auto"},at=z({__name:"TimelinePage",setup(S){return(n,i)=>(b(),w("div",tt,[y(l(et))]))}});export{at as default};
